socket.on("create",a=>{const b=new Peer(void 0,{host:"/",path:"/peerjs",port:3030});socket.on("destroyConnect",()=>{b.destroy()}),b.on("open",function(b){socket.emit("created",b,a)}),b.on("call",a=>{navigator.mediaDevices.getUserMedia({video:!1,audio:!0}).then(c=>{a.answer(c),a.on("stream",a=>{const b=document.createElement("audio");document.body.appendChild(b),b.srcObject=a,b.play()}),b.on("disconnected",function(){b.reconnect()})})}),socket.on("user-connected",(a,c)=>{c.forEach(c=>{c!==a&&navigator.mediaDevices.getUserMedia({video:!1,audio:!0}).then(a=>{let d=b.call(c,a);d.on("stream",function(a){const b=document.createElement("audio");document.body.appendChild(b),b.srcObject=a,b.play()}),b.on("disconnected",function(){b.reconnect()})})})})});const scrollToBottom=()=>{const a=$(".chat-window");a.scrollTop(a.prop("scrollHeight"))};socket.on("addUser",a=>{const b=document.querySelectorAll(".userName");audioUsers=[],b.forEach(a=>{audioUsers.push(a.innerHTML)});const c=audioUsers.filter(b=>b===a);if(0===c.length){$("#appendAudio").append(`<li class='userName'>${a}</li>`);const b=$(document.createElement("div"));b.html(`<div class="userPos" id="userPos_${a}" userPosx="0" userPosy="0" userPosz="0"  style="display:none"></div>`),$("#allUserPos").append(b)}}),socket.on("user-disconnected",async a=>{try{const b=document.querySelectorAll(".userName");b.forEach(b=>{b.innerHTML===a.name&&b.remove()})}catch(a){console.log(a)}}),socket.on("audioUsers",(a,b)=>{a.forEach(a=>{(a.audio.channel=b)&&$("#appendAudio").append(`<li class='userName'>${a.name}</li>`)})}),socket.on("newDM",(a,b)=>{if("/messages"===window.location.pathname&&$("#chatter").text()===b){const c=$(document.createElement("div"));c.html(`<div  class="row card mb-2 p-3 message-card">
    <div id="dmReceiver" class="card-header p-1" style="background-color: transparent; border: none;">
    ${b}<small class="text-muted">${new Date(a.createdAt).toLocaleString()}
        </small><div class="card-body p-1"> ${a.text}</div>
        </div>
        </div>`),console.log(c),$("#chatCards").append(c),scrollToBottom()}}),socket.on("dmMessages",a=>{const b=[];a.forEach(a=>{b.push(a.name)});let c=[...new Set(b)];c.forEach(a=>{const b=$(document.createElement("div"));b.html(`<div  class="row card mb-2 p-3 message-card">
    <div class="card-header p-1" style="background-color: transparent; border: none;"><div><span style="border-radius: 50%; border:solid red 1px; padding-right: 8.5px; padding-left: 8.5px" id="notifyUnread${a}"></span><button id="msgName" class="btn text-light">${a}</button></div>
    </div>
    </div>`),$("#directMessages").append(b)});let d=localStorage.getItem("userLastCheckedMessages"),e=new Date(d),f=0;a.forEach(a=>{let b=new Date(a.createdAt);!0==b>=e&&++f;var c=$(`#notifyUnread${a.name}`);c.text(`${f}`)})}),socket.on("populateDM",a=>{let b=new Date;a.forEach(a=>{const c=$(document.createElement("div"));c.html(`<div  class="row card mb-2 p-3 message-card">
    <div id="dmSender" class="card-header p-1" style="background-color: transparent; border: none;">
    ${a.name} <small class="text-muted"> ${new Date(a.createdAt).toLocaleString()}
        </small> </div><div class="card-body p-1"> ${a.text}</div>
        </div>`),$("#chatCards").append(c),scrollToBottom(),localStorage.setItem("userLastCheckedMessages",b)})}),socket.on("createMessage",(a,b)=>{const c=$("<div>");c.html(`<div  class="row card mb-2 p-3 message-card">
  <div class="card-header p-1" style="background-color: transparent; border: none;">
    ${b} <small class="text-muted">${new Date().toLocaleString()}</small>
  </div>
  <div class="card-body p-1">
    ${a}
  </div>
</div>`),$("#chatCards").append(c),scrollToBottom()});async function signup(a,b){try{const c=await fetch("/sign-up",{method:"POST",body:JSON.stringify({name:a,password:b}),headers:{"Content-Type":"application/json"}});if(c.ok){const a=await c.json();$("#message").text(a.message),document.location.replace("/")}}catch(a){console.log(a)}}async function login(a,b){try{const c=await fetch("/sign-in",{method:"POST",body:JSON.stringify({name:a,password:b}),headers:{"Content-Type":"application/json"}});if(c.ok){const a=await c.json();$("#error").text(""),$("#message").text(a.message),document.location.replace("/homepage")}const d=await c.json();$("#error").text(d.message)}catch(a){console.log(a)}}const logout=async()=>{try{const a=await fetch("/logout",{method:"POST",headers:{"Content-Type":"application/json"}});a.ok&&document.location.replace("/");const b=await a.json();$("#message").text(b.message)}catch(a){console.log(a)}},joinAudio=async a=>{socket.emit("audio-joined",$("#audioChannel1").attr("data-audio"),a)};$("#logout").on("click",function(a){a.preventDefault(),localStorage.removeItem("username"),logout()}),$("#createAccount").on("click",function(a){a.preventDefault(),signup($("#id").val(),$("#pw").val())}),$("#signIn").on("click",function(a){a.preventDefault(),login($("#id").val(),$("#pw").val())}),$("#chat-message").keydown(function(a){if(13===a.which&&0!==$("#chat-message").val().length){const a=$("#chat-message").val().trim(),b=$("#room").attr("data-room"),c=fetch(`/room/${b}`,{method:"POST",body:JSON.stringify({text:a}),headers:{"Content-Type":"application/json"}});socket.emit("message",$("#chat-message").val(),localStorage.getItem("username")),$("#chat-message").val(""),c.ok&&console.log(c)}}),$("#makeRoomCode").on("click",async function(){const a=$("#addCode").val().trim();if(a){const b=await fetch("/roomscode",{method:"POST",body:JSON.stringify({code:a}),headers:{"Content-Type":"application/json"}});b.ok?document.location.replace("/rooms"):alert("FAIL")}}),$("#audioChannel1").on("click",()=>{const a=localStorage.getItem("username"),b=document.querySelectorAll(".userName");0===b.length?($("#appendAudio").append(`<li class='userName'>${a}</li>`),joinAudio(a)):b.forEach(b=>{b.innerHTML!==a&&(socket.emit("userJoin",a,$("#audioChannel1").attr("data-room")),joinAudio(a))})}),$("#dm-input").keydown(function(a){if(13===a.which&&0!==$("#dm-input").val().length){const a=localStorage.getItem("username"),b=$("#dm-input").val();socket.emit("dm-message",$("#dm-name").val(),b,a);const c=$(document.createElement("div"));c.html(`<div  class="row card mb-2 p-3 message-card">
    <div id="dmSender" class="card-header p-1" style="background-color: transparent; border: none;">
    ${a}<small class="text-muted"> ${new Date().toLocaleString()}
          </small><div class="card-body p-1"> ${b}</div>
          </div>
          </div>`),$("#chatCards").append(c),$("#dm-input").val(""),scrollToBottom()}}),document.addEventListener("click",function(a){"msgName"===a.target.id&&$("#dmSender").text()!==a.target.innerText&&($("#chatCards").empty(),$("#chatter").text(`${a.target.innerText}`),$("#dm-name").val(`${a.target.innerText}`),socket.emit("getDM",a.target.innerText,localStorage.getItem("username")))}),$("#makeRoom").on("click",async()=>{const a=$("#roomTitle").val().trim();if(a){const b=await fetch("/rooms",{method:"POST",body:JSON.stringify({title:a}),headers:{"Content-Type":"application/json"}});if(b.ok)location.reload();else return}}),$("#addBtn").on("click",()=>{$("#modalBg").fadeIn()}),$("#closeModal").on("click",()=>{$("#roomTitle").val(""),$("#addCode").val(""),$("#modalBg").fadeOut()});const copyRoom=a=>{const b=$(a).attr("data-code"),c=$("<textarea>");$(c).val(b),$(c).css("position","absolute"),$(c).css("left","-99999px"),$("body").append(c),c.select(),document.execCommand("copy"),$(c).remove()},updateLocalStorage=()=>{const a=$("#select").attr("data-name");localStorage.setItem("username",a),socket.emit("update-socket",localStorage.getItem("username"))};updateLocalStorage(),$("#leaveRoom").on("click",async()=>{const a=$("#user").attr("data-user"),b=$("#audioChannel1").attr("data-room"),c=await fetch(`/room/${b}`,{method:"DELETE",body:JSON.stringify({user_id:a,room_id:b}),headers:{"Content-Type":"application/json"}});c.ok?document.location.replace("/rooms"):alert("something went wrong!")}),socket.on("removeUser",a=>{const b=document.querySelectorAll(".userName");b.forEach(b=>{b.innerHTML===a&&b.remove()})}),$("#leaveVoice").on("click",async()=>{const a=localStorage.getItem("username");socket.emit("userLeft",a,$("#audioChannel1").attr("data-room")),socket.emit("peerDestroy",a)});const notif=(a,b)=>{const c=$("<div>");$(c).css("display","none"),$(c).html(`<div id="alert" class="alert alert-dark" role="alert">
  <h4 class="alert-heading">${b}
  <small class="text-dark text-muted">${new Date().toLocaleString()}</small></h4>
  <hr>
  <p class="text-primary">${a}</p>
  </div>`),$("body").append(c),$(c).fadeIn(),setTimeout(function(){$(c).fadeOut()},5e3)};socket.on("notification",(a,b)=>{notif(a,b)});